<UserControl x:Class="Wind.Views.TabBar"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
             xmlns:converters="clr-namespace:Wind.Converters"
             mc:Ignorable="d"
             d:DesignHeight="48" d:DesignWidth="800">

    <UserControl.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibility"/>
        <converters:NullToVisibilityConverter x:Key="NullToVisibility"/>
        <converters:ColorToBrushConverter x:Key="ColorToBrush"/>

        <!-- Tab Item Style -->
        <Style x:Key="TabItemStyle" TargetType="Border">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0,0,0,2"/>
            <Setter Property="Margin" Value="2,4"/>
            <Setter Property="Padding" Value="8,6"/>
            <Setter Property="CornerRadius" Value="6,6,0,0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{DynamicResource ControlFillColorSecondaryBrush}"/>
                </Trigger>
                <DataTrigger Binding="{Binding IsSelected}" Value="True">
                    <Setter Property="Background" Value="{DynamicResource ControlFillColorDefaultBrush}"/>
                    <Setter Property="BorderBrush" Value="{DynamicResource AccentFillColorDefaultBrush}"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>

    <Border Background="{DynamicResource ApplicationBackgroundBrush}"
            BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
            BorderThickness="0,0,0,1">
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- Tab List -->
            <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled">
                <StackPanel Orientation="Horizontal" Margin="8,0">
                    <!-- Groups -->
                    <ItemsControl ItemsSource="{Binding Groups}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="{Binding Color, Converter={StaticResource ColorToBrush}}"
                                        CornerRadius="8" Margin="0,4,8,4" Padding="4">
                                    <StackPanel Orientation="Horizontal">
                                        <!-- Group Header -->
                                        <Border Background="{DynamicResource ControlFillColorDefaultBrush}"
                                                CornerRadius="4" Padding="6,4" Margin="0,0,4,0">
                                            <StackPanel Orientation="Horizontal">
                                                <ui:SymbolIcon Symbol="Folder24" FontSize="14" Margin="0,0,4,0"
                                                               Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                                                <TextBlock Text="{Binding Name}" FontSize="12" FontWeight="SemiBold"
                                                           Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                                            </StackPanel>
                                        </Border>

                                        <!-- Group Tabs -->
                                        <ItemsControl ItemsSource="{Binding Tabs}">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <StackPanel Orientation="Horizontal"/>
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border Style="{StaticResource TabItemStyle}"
                                                            MouseLeftButtonDown="TabItem_MouseLeftButtonDown"
                                                            Tag="{Binding}">
                                                        <StackPanel Orientation="Horizontal">
                                                            <Image Source="{Binding Icon}" Width="16" Height="16"
                                                                   Margin="0,0,6,0" VerticalAlignment="Center"/>
                                                            <TextBlock Text="{Binding Title}" MaxWidth="150"
                                                                       TextTrimming="CharacterEllipsis"
                                                                       VerticalAlignment="Center"
                                                                       Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                                                            <ui:Button Appearance="Transparent" Padding="4"
                                                                       Margin="6,0,0,0" Click="CloseTab_Click"
                                                                       Tag="{Binding}"
                                                                       Foreground="{DynamicResource TextFillColorSecondaryBrush}">
                                                                <ui:SymbolIcon Symbol="Dismiss12" FontSize="10"/>
                                                            </ui:Button>
                                                        </StackPanel>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- Ungrouped Tabs -->
                    <ItemsControl ItemsSource="{Binding Tabs}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Style="{StaticResource TabItemStyle}"
                                        MouseLeftButtonDown="TabItem_MouseLeftButtonDown"
                                        Tag="{Binding}"
                                        Visibility="{Binding Group, Converter={StaticResource NullToVisibility}, ConverterParameter=invert}">
                                    <StackPanel Orientation="Horizontal">
                                        <Image Source="{Binding Icon}" Width="16" Height="16"
                                               Margin="0,0,6,0" VerticalAlignment="Center"/>
                                        <TextBlock Text="{Binding Title}" MaxWidth="150"
                                                   TextTrimming="CharacterEllipsis"
                                                   VerticalAlignment="Center"
                                                   Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                                        <ui:Button Appearance="Transparent" Padding="4"
                                                   Margin="6,0,0,0" Click="CloseTab_Click"
                                                   Tag="{Binding}"
                                                   Foreground="{DynamicResource TextFillColorSecondaryBrush}">
                                            <ui:SymbolIcon Symbol="Dismiss12" FontSize="10"/>
                                        </ui:Button>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </ScrollViewer>

            <!-- Actions -->
            <StackPanel Grid.Column="1" Orientation="Horizontal" Margin="8,0">
                <ui:Button Content="+ Add Window" Command="{Binding OpenWindowPickerCommand}"
                           Appearance="Primary" Margin="0,4"/>
                <ui:Button ToolTip="Create Group" Command="{Binding CreateGroupCommand}"
                           Appearance="Secondary" Margin="8,4" Padding="8">
                    <ui:SymbolIcon Symbol="FolderAdd24"/>
                </ui:Button>
            </StackPanel>
        </Grid>
    </Border>
</UserControl>
